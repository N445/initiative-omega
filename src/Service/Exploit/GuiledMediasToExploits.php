<?php

namespace App\Service\Exploit;

use App\Entity\Exploit\Exploit;
use App\Model\Guilded\Media;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Component\Filesystem\Filesystem;
use Symfony\Component\HttpFoundation\File\UploadedFile;
use Symfony\Component\String\Slugger\AsciiSlugger;

class GuiledMediasToExploits
{
    private EntityManagerInterface $em;

    public function __construct(
        EntityManagerInterface $entityManager
    )
    {
        $this->em = $entityManager;
    }

    /**
     * @param Media[] $medias
     * @return void
     */
    public function populate(array $medias)
    {
        $fileSystem = new Filesystem();
        $sluger     = new AsciiSlugger();
        foreach ($medias as $media) {
            $tmp = $fileSystem->tempnam(sys_get_temp_dir(), 'media_exploit_');
            file_put_contents($tmp, file_get_contents($media->getSrc()));
            $exploit = new Exploit();
            $exploit->setName($media->getTitle());
            $exploit->setImageFile(new UploadedFile($tmp, $sluger->slug($media->getTitle())->lower() . '.jpg', null, null, true));
            $exploit->setIsActive(true);
            $this->em->persist($exploit);
        }
        $this->em->flush();
    }
}
